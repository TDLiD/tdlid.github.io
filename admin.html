<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TDLiD Admin - Analytics & Notice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        .cyber-border { border: 1px solid rgba(34, 211, 238, 0.2); }
        body { background-color: #020617; font-family: 'Pretendard', sans-serif; }
        .text-xxs { font-size: 0.65rem; }
        input, textarea { background: #0f172a !important; border: 1px solid #1e293b !important; color: white !important; }
        .edit-mode { border-color: #f59e0b !important; box-shadow: 0 0 15px rgba(245, 158, 11, 0.2); }
    </style>
</head>
<body class="text-neutral-200 p-5 md:p-10">

    <div class="max-w-7xl mx-auto">
        <header class="flex justify-between items-center mb-10 border-b border-cyan-900/50 pb-6">
            <div>
                <h1 class="text-3xl font-bold text-cyan-400 tracking-tighter italic">ADMIN CONTROL CENTER</h1>
                <p class="text-neutral-500 text-sm mt-1 uppercase tracking-widest">Notice & Analytics Management</p>
            </div>
            <button onclick="location.reload()" class="px-4 py-2 bg-cyan-900/30 border border-cyan-500/50 text-cyan-400 rounded-lg hover:bg-cyan-500 hover:text-black transition font-bold">REFRESH</button>
        </header>

        <section id="noticeFormSection" class="mb-12 bg-neutral-900/50 p-6 rounded-2xl cyber-border transition-all">
            <h3 id="formTitle" class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                <span class="w-2 h-2 bg-cyan-500 rounded-full animate-ping"></span>
                POST NEW NOTICE
            </h3>
            <input type="hidden" id="editKey"> 
            <div class="grid grid-cols-1 gap-4">
                <input type="text" id="noticeTitle" placeholder="Please enter a title for your notice." class="w-full p-3 rounded-lg focus:ring-2 focus:ring-cyan-500 outline-none">
                <textarea id="noticeContent" rows="3" placeholder="Please enter the details of the notice." class="w-full p-3 rounded-lg focus:ring-2 focus:ring-cyan-500 outline-none"></textarea>
                <div class="flex gap-2">
                    <button id="submitBtn" onclick="uploadNotice()" class="flex-1 py-3 bg-cyan-600 hover:bg-cyan-500 text-white font-bold rounded-lg transition shadow-lg">REGISTER NOTICE (POST)</button>
                    <button id="cancelBtn" onclick="resetForm()" class="hidden px-6 py-3 bg-neutral-700 hover:bg-neutral-600 text-white font-bold rounded-lg transition">CANCEL</button>
                </div>
            </div>
        </section>

        <section class="mb-12 bg-neutral-900/80 rounded-2xl cyber-border overflow-hidden shadow-2xl">
            <div class="p-4 border-b border-white/5 bg-white/5 font-bold text-xs tracking-widest text-cyan-400 uppercase">Manage Published Notices</div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead>
                        <tr class="bg-neutral-950 text-neutral-400 text-[10px] uppercase tracking-wider">
                            <th class="p-4">Date</th>
                            <th class="p-4">Title</th>
                            <th class="p-4 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="noticeTableBody" class="divide-y divide-neutral-800 text-sm"></tbody>
                </table>
            </div>
        </section>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-10">
            <div class="bg-neutral-900/50 p-6 rounded-2xl cyber-border">
                <p class="text-neutral-500 text-xs font-bold tracking-widest uppercase text-cyan-500/70">Unique Visitors</p>
                <h2 id="uniqueCount" class="text-4xl font-bold text-white mt-2 font-mono">0</h2>
            </div>
            <div class="bg-neutral-900/50 p-6 rounded-2xl cyber-border border-dashed">
                <p class="text-neutral-500 text-xs font-bold tracking-widest uppercase">Total Hits</p>
                <h2 id="totalCount" class="text-2xl font-bold text-cyan-600 mt-2 font-mono">0</h2>
            </div>
        </div>

        <div class="bg-neutral-900/80 rounded-2xl cyber-border overflow-hidden shadow-2xl">
            <div class="p-4 border-b border-white/5 bg-white/5 font-bold text-xs tracking-widest text-neutral-400 uppercase">Live Visitor Logs</div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead>
                        <tr class="bg-cyan-950/40 text-cyan-300 text-[10px] uppercase tracking-[0.2em]">
                            <th class="p-5 border-r border-white/5 text-center">Hits</th>
                            <th class="p-5">Latest Access / IP</th>
                            <th class="p-5">Location / Session</th>
                            <th class="p-5 text-center">OS & Browser</th>
                            <th class="p-5">Current Page / Referrer</th>
                        </tr>
                    </thead>
                    <tbody id="visitTableBody" class="divide-y divide-neutral-800 text-sm italic"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDwF8_Q9S1-naaAgyfMWhFYJ2u_be3wsBs",
            authDomain: "tdlid-107669.firebaseapp.com",
            databaseURL: "https://tdlid-107669-default-rtdb.firebaseio.com",
            projectId: "tdlid-107669",
            storageBucket: "tdlid-107669.firebasestorage.app",
            messagingSenderId: "604782345004",
            appId: "1:604782345004:web:029aeaa81f4d11c2254a89"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // --- Notice Logic ---

        function uploadNotice() {
            const title = document.getElementById('noticeTitle').value;
            const content = document.getElementById('noticeContent').value;
            const editKey = document.getElementById('editKey').value;
            
            if(!title || !content) return alert("Please enter both title and content.");

            const noticeData = {
                title: title,
                content: content,
                date: new Date().toLocaleDateString(),
                timestamp: Date.now()
            };

            if (editKey) {
                // Update Mode
                database.ref('notices/' + editKey).update(noticeData).then(() => {
                    alert("Notice updated successfully.");
                    resetForm();
                });
            } else {
                // New Post Mode
                database.ref('notices').push(noticeData).then(() => {
                    alert("Notice posted successfully.");
                    resetForm();
                });
            }
        }

        function prepareEdit(key, title, content) {
            document.getElementById('editKey').value = key;
            document.getElementById('noticeTitle').value = title;
            document.getElementById('noticeContent').value = content;
            
            document.getElementById('formTitle').innerText = "EDIT NOTICE";
            document.getElementById('submitBtn').innerText = "UPDATE NOTICE (SAVE)";
            document.getElementById('submitBtn').classList.replace('bg-cyan-600', 'bg-amber-600');
            document.getElementById('noticeFormSection').classList.add('edit-mode');
            document.getElementById('cancelBtn').classList.remove('hidden');
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function resetForm() {
            document.getElementById('editKey').value = '';
            document.getElementById('noticeTitle').value = '';
            document.getElementById('noticeContent').value = '';
            document.getElementById('formTitle').innerText = "POST NEW NOTICE";
            document.getElementById('submitBtn').innerText = "REGISTER NOTICE (POST)";
            document.getElementById('submitBtn').classList.replace('bg-amber-600', 'bg-cyan-600');
            document.getElementById('noticeFormSection').classList.remove('edit-mode');
            document.getElementById('cancelBtn').classList.add('hidden');
        }

        function deleteNotice(key) {
            if(confirm("Are you sure you want to delete this notice?")) {
                database.ref('notices/' + key).remove().then(() => alert("Deleted successfully."));
            }
        }

        database.ref('notices').orderByChild('timestamp').on('value', (snapshot) => {
            const tbody = document.getElementById('noticeTableBody');
            tbody.innerHTML = '';
            
            let items = [];
            snapshot.forEach(child => {
                items.push({ key: child.key, ...child.val() });
            });
            items.reverse();

            items.forEach(item => {
                const tr = `
                    <tr class="hover:bg-white/5 transition">
                        <td class="p-4 text-neutral-500 text-xs">${item.date}</td>
                        <td class="p-4 font-bold text-neutral-200">${item.title}</td>
                        <td class="p-4 text-right space-x-2">
                            <button onclick="prepareEdit('${item.key}', \`${item.title}\`, \`${item.content}\`)" class="text-cyan-400 hover:text-cyan-300 text-xs font-bold uppercase">Edit</button>
                            <button onclick="deleteNotice('${item.key}')" class="text-red-500 hover:text-red-400 text-xs font-bold uppercase">Delete</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += tr;
            });
        });

        // --- Visitor Analytics Logic ---

        function loadFirebaseData() {
            const tableBody = document.getElementById('visitTableBody');
            const totalCountEl = document.getElementById('totalCount');
            const uniqueCountEl = document.getElementById('uniqueCount');

            database.ref('visits').orderByChild('timestamp').on('value', (snapshot) => {
                tableBody.innerHTML = '';
                let rawData = [];
                snapshot.forEach((child) => { rawData.push(child.val()); });
                rawData.reverse();

                const groupedData = {};
                rawData.forEach((visit) => {
                    const groupKey = `${visit.ip || 'unknown'}_${visit.device}`;
                    if (!groupedData[groupKey]) {
                        groupedData[groupKey] = { ...visit, count: 1 };
                    } else {
                        groupedData[groupKey].count += 1;
                    }
                });

                const displayData = Object.values(groupedData);
                totalCountEl.innerText = rawData.length;
                uniqueCountEl.innerText = displayData.length;

                displayData.forEach((visit) => {
                    const row = `
                        <tr class="hover:bg-cyan-400/5 transition-colors">
                            <td class="p-5 text-center border-r border-white/5">
                                <span class="bg-cyan-500/20 text-cyan-400 px-3 py-1 rounded-full text-xs font-bold ring-1 ring-cyan-500/30">${visit.count}</span>
                            </td>
                            <td class="p-5">
                                <div class="text-neutral-400 text-xs font-mono">${visit.timeStr}</div>
                                <div class="text-cyan-500 text-sm font-black mt-1 tracking-wider">${visit.ip || '0.0.0.0'}</div>
                            </td>
                            <td class="p-5">
                                <div class="text-white font-bold">${visit.country || 'Unknown'} (${visit.city || '-'})</div>
                                <div class="text-neutral-600 text-[10px] font-mono mt-1 uppercase tracking-tighter">ID: ${visit.sid || 'No Session'}</div>
                            </td>
                            <td class="p-5 text-center">
                                <div class="flex flex-col gap-1 items-center">
                                    <span class="px-2 py-1 rounded text-xxs bg-neutral-800 text-neutral-300 border border-neutral-700 w-20">${visit.os || 'Unknown OS'}</span>
                                    <span class="px-2 py-1 rounded text-xxs bg-blue-900/30 text-blue-400 border border-blue-500/20 w-20">${visit.browser || 'Unknown'}</span>
                                </div>
                            </td>
                            <td class="p-5">
                                <div class="font-bold text-cyan-400 text-xs uppercase">${visit.page}</div>
                                <div class="text-neutral-600 italic text-[10px] truncate max-w-[180px] mt-1">${visit.referrer || 'Direct'}</div>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            });
        }
        
        window.onload = loadFirebaseData;
    </script>
</body>
</html>