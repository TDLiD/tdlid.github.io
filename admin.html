<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TDLiD Admin - Analytics, Notice & News</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

    <style>
        .cyber-border { border: 1px solid rgba(34, 211, 238, 0.2); }
        body { background-color: #020617; font-family: 'Pretendard', sans-serif; }
        .text-xxs { font-size: 0.65rem; }
        input, select { background: #0f172a !important; border: 1px solid #1e293b !important; color: white !important; }
        .edit-mode { border-color: #f59e0b !important; box-shadow: 0 0 15px rgba(245, 158, 11, 0.2); }

        .ql-toolbar { background: #1e293b !important; border-color: #334155 !important; border-radius: 8px 8px 0 0; }
        .ql-container { background: #0f172a !important; border-color: #334155 !important; border-radius: 0 0 8px 8px; min-height: 200px; color: white; font-size: 1rem; }
        .ql-stroke { stroke: #94a3b8 !important; }
        .ql-fill { fill: #94a3b8 !important; }
        .ql-picker { color: #94a3b8 !important; }

        .unread-row { background-color: rgba(34, 211, 238, 0.05); }

       /* 기존 .modal-overlay 찾아서 수정 */
.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
    display: none; 
    justify-content: center; 
    align-items: flex-start; /* center에서 flex-start로 변경 */
    padding-top: 15vh;        /* 화면 높이의 15%만큼 아래로 내림 */
    z-index: 9999;
}

        .modal-content {
            background: #0f172a; border: 1px solid rgba(34, 211, 238, 0.3);
            width: 90%; max-width: 600px; border-radius: 1rem; overflow: hidden;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }

        .ql-editor.ql-blank::before {
            color: rgba(255, 255, 255, 0.6) !important;
            font-style: normal;
        }
        
        /* [추가] 헤더 스타일 보정 */
        #header-placeholder { margin-bottom: 2rem; }

    </style>


</head>
<body class="text-neutral-200 p-0"> <div id="header-placeholder"></div>

<div id="pwModal" class="modal-overlay" onclick="closePwModal()">
    <div class="modal-content max-w-sm" onclick="event.stopPropagation()">
        <div class="p-4 border-b border-white/10 bg-white/5 flex justify-between items-center">
            <h4 class="font-bold text-cyan-400">Change Admin Password</h4>
            <button onclick="closePwModal()" class="text-neutral-400 hover:text-white">✕</button>
        </div>
        <div class="p-6 space-y-4">
<input type="text" id="inlineNewPw" placeholder="Enter New Admin Password" 
       class="flex-1 bg-black/40 border border-neutral-700 p-2 rounded-lg text-sm outline-none focus:border-cyan-500 transition">
            <button onclick="updateAdminPassword()" class="w-full py-3 bg-cyan-600 text-white font-bold rounded-lg hover:bg-cyan-500 transition">UPDATE PASSWORD</button>
        </div>
    </div>
</div>


    <div id="inquiryModal" class="modal-overlay" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="p-4 border-b border-white/10 bg-white/5 flex justify-between items-center">
                <h4 class="font-bold text-cyan-400">Inquiry Details</h4>
                <button onclick="closeModal()" class="text-neutral-400 hover:text-white text-xl">✕</button>
            </div>
            <div class="p-6 space-y-4">
                <div class="grid grid-cols-2 gap-4 text-xs">
                    <div><p class="text-neutral-500 uppercase font-bold">Name</p><p id="modalName" class="text-white text-base font-bold"></p></div>
                    <div><p class="text-neutral-500 uppercase font-bold">Date</p><p id="modalDate" class="text-white"></p></div>
                    <div><p class="text-neutral-500 uppercase font-bold">Company</p><p id="modalCompany" class="text-cyan-400 text-base font-bold"></p></div>
                    <div><p class="text-neutral-500 uppercase font-bold">Product</p><p id="modalProduct" class="text-amber-400 font-bold"></p></div>
                    <div><p class="text-neutral-500 uppercase font-bold">Email</p><p id="modalEmail" class="text-white"></p></div>
                    <div><p class="text-neutral-500 uppercase font-bold">Phone</p><p id="modalPhone" class="text-white"></p></div>
                </div>
                <div class="pt-4 border-t border-white/5">
                    <p class="text-neutral-500 uppercase text-xs font-bold mb-2">Message</p>
                    <div id="modalMessage" class="text-neutral-200 leading-relaxed whitespace-pre-wrap bg-black/30 p-4 rounded-lg border border-white/5 max-h-[300px] overflow-y-auto font-mono text-sm"></div>
                </div>
            </div>
            <div class="p-4 bg-white/5 text-right">
                <button onclick="closeModal()" class="px-6 py-2 bg-neutral-700 hover:bg-neutral-600 rounded-lg text-sm font-bold transition">CLOSE</button>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-5 md:px-10 pb-20">
      <header class="mb-10 border-b border-cyan-900/50 pb-6">
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-bold text-cyan-400 tracking-tighter italic">ADMIN CONTROL CENTER</h1>
            <p class="text-neutral-500 text-sm mt-1 uppercase tracking-widest">Notice & News & Analytics</p>
        </div>
        <div class="flex gap-3">
            <button onclick="location.reload()" class="px-4 py-2 bg-cyan-900/30 border border-cyan-500/50 text-cyan-400 rounded-lg hover:bg-cyan-500 hover:text-black transition font-bold text-sm">REFRESH</button>
        </div>
    </div>

<div class="bg-neutral-900/40 border border-white/5 rounded-xl p-4 flex flex-wrap items-center gap-4">
    <div class="flex items-center gap-2">
        <span class="text-cyan-500 text-xs font-black uppercase tracking-widest">Security</span>
        <div class="h-4 w-[1px] bg-white/10 mx-2"></div>
    </div>
    <div class="flex-1 min-w-[200px] flex gap-2">
        <input type="text" id="adminNewPassword" placeholder="Enter New Admin Password" 
               class="flex-1 bg-black/40 border border-neutral-700 p-2 rounded-lg text-sm outline-none focus:border-cyan-500 transition">
        <button onclick="updateAdminPassword()" 
                class="px-6 py-2 bg-neutral-800 hover:bg-cyan-600 text-white text-xs font-bold rounded-lg transition border border-neutral-600 hover:border-cyan-500 whitespace-nowrap">
            CHANGE PASSWORD
        </button>
    </div>
    <p class="text-neutral-600 text-[10px] w-full md:w-auto">* This password is used for the 'Admin' button in the header.</p>
</div>


</header>


        <section id="inquirySection" class="mb-12 bg-neutral-900/80 rounded-2xl cyber-border overflow-hidden shadow-2xl">
            <div class="p-4 border-b border-white/5 bg-white/5 flex justify-between items-center">
                <span class="font-bold text-xs tracking-widest text-amber-400 uppercase">Customer Inquiry List</span>
                <span id="unreadCount" class="bg-amber-600 text-white text-[10px] px-2 py-0.5 rounded-full font-bold">0 NEW</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead>
                        <tr class="bg-neutral-950 text-neutral-400 text-[10px] uppercase tracking-wider">
                            <th class="p-4">Status</th>
                            <th class="p-4">Date / Name</th>
                            <th class="p-4">Company / Product</th>
                            <th class="p-4">Message</th>
                            <th class="p-4 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="inquiryTableBody" class="divide-y divide-neutral-800 text-sm"></tbody>
                </table>
            </div>
        </section>

        <section id="noticeFormSection" class="mb-12 bg-neutral-900/50 p-6 rounded-2xl cyber-border transition-all">
            <h3 id="formTitle" class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                <span class="w-2 h-2 bg-cyan-500 rounded-full animate-ping"></span>
                POST NEW CONTENT (NOTICE / NEWS)
            </h3>
            <input type="hidden" id="editKey"> 
            <div class="grid grid-cols-1 gap-4">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <select id="postCategory" onchange="updateFormText()" class="md:col-span-1 p-3 rounded-lg focus:ring-2 focus:ring-cyan-500 outline-none font-bold text-cyan-400 cursor-pointer">
                        <option value="notice">ANNOUNCEMENT (NOTICE)</option>
                        <option value="news">LATEST NEWS (NEWS)</option>
                    </select>
                    <input type="text" id="noticeTitle" placeholder="Enter title here..." class="md:col-span-3 p-3 rounded-lg focus:ring-2 focus:ring-cyan-500 outline-none">
                </div>
                <div id="editor-container"></div>
                <div class="flex gap-2">
                    <button id="submitBtn" onclick="uploadNotice()" class="flex-1 py-3 bg-cyan-600 hover:bg-cyan-500 text-white font-bold rounded-lg transition shadow-lg uppercase">Register Post</button>
                    <button id="cancelBtn" onclick="resetForm()" class="hidden px-6 py-3 bg-neutral-700 hover:bg-neutral-600 text-white font-bold rounded-lg transition">CANCEL</button>
                </div>
            </div>
        </section>

        <section class="mb-12 bg-neutral-900/80 rounded-2xl cyber-border overflow-hidden shadow-2xl">
            <div class="p-4 border-b border-white/5 bg-white/5 font-bold text-xs tracking-widest text-cyan-400 uppercase">Manage Published Notice & News</div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead>
                        <tr class="bg-neutral-950 text-neutral-400 text-[10px] uppercase tracking-wider">
                            <th class="p-4">Category</th><th class="p-4">Date</th><th class="p-4">Title</th><th class="p-4 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="noticeTableBody" class="divide-y divide-neutral-800 text-sm"></tbody>
                </table>
            </div>
        </section>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-10">
            <div class="bg-neutral-900/50 p-6 rounded-2xl cyber-border">
                <p class="text-neutral-500 text-xs font-bold tracking-widest uppercase text-cyan-500/70">Unique Visitors</p>
                <h2 id="uniqueCount" class="text-4xl font-bold text-white mt-2 font-mono">0</h2>
            </div>
            <div class="bg-neutral-900/50 p-6 rounded-2xl cyber-border border-dashed">
                <p class="text-neutral-500 text-xs font-bold tracking-widest uppercase">Total Hits</p>
                <h2 id="totalCount" class="text-2xl font-bold text-cyan-600 mt-2 font-mono">0</h2>
            </div>
        </div>

        <div class="bg-neutral-900/80 rounded-2xl cyber-border overflow-hidden shadow-2xl">
            <div class="p-4 border-b border-white/5 bg-white/5 font-bold text-xs tracking-widest text-neutral-400 uppercase">Live Visitor Logs</div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead>
                        <tr class="bg-cyan-950/40 text-cyan-300 text-[10px] uppercase tracking-[0.2em]">
                            <th class="p-5 text-center">Hits</th><th class="p-5">Latest Access / IP</th><th class="p-5">Location / Session</th><th class="p-5 text-center">OS & Browser</th><th class="p-5">Current Page</th>
                        </tr>
                    </thead>
                    <tbody id="visitTableBody" class="divide-y divide-neutral-800 text-sm italic"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // [기존 Firebase 설정 동일]
        const firebaseConfig = {
            apiKey: "AIzaSyDwF8_Q9S1-naaAgyfMWhFYJ2u_be3wsBs",
            authDomain: "tdlid-107669.firebaseapp.com",
            databaseURL: "https://tdlid-107669-default-rtdb.firebaseio.com",
            projectId: "tdlid-107669",
            storageBucket: "tdlid-107669.firebasestorage.app",
            messagingSenderId: "604782345004",
            appId: "1:604782345004:web:029aeaa81f4d11c2254a89"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // [추가] 헤더 로드 기능
        async function loadHeader() {
            try {
                const res = await fetch('components/header.html');
                const html = await res.text();
                document.getElementById('header-placeholder').innerHTML = html;
                if (typeof initNavigation === "function") initNavigation();
            } catch (e) { console.error("Header load failed", e); }
        }

        // [추가] 비밀번호 변경 로직
        function openPwModal() { document.getElementById('pwModal').style.display = 'flex'; }
        function closePwModal() { document.getElementById('pwModal').style.display = 'none'; }

// 비밀번호 업데이트 함수 (통합)
async function updateAdminPassword() {
    const passwordInput = document.getElementById('adminNewPassword');
    const newPw = passwordInput.value;
    
    if(!newPw) {
        alert("Please enter a new password.");
        return;
    }

    if(confirm("Are you sure you want to change the admin password?")) {
        try {
            await database.ref('adminConfig/password').set(newPw);
            alert("Password has been updated successfully.");
            // 선택 사항: 저장 후 입력창을 비우고 싶지 않다면 아래 줄 주석 처리
            // passwordInput.value = ''; 
        } catch(e) {
            console.error(e);
            alert("Failed to update password. Check Firebase permissions.");
        }
    }
}


        // [기존 Inquiry, Notice, Analytics 로직 동일 유지]
        function escapeHtml(text) { const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }; return text ? String(text).replace(/[&<>"']/g, m => map[m]) : ''; }
        function openInquiry(key, name, date, company, email, details, phone, product) {
            document.getElementById('modalName').innerText = name;
            document.getElementById('modalDate').innerText = date;
            document.getElementById('modalCompany').innerText = company;
            document.getElementById('modalEmail').innerText = email;
            document.getElementById('modalMessage').innerText = details;
            document.getElementById('modalPhone').innerText = phone || 'N/A';
            document.getElementById('modalProduct').innerText = product || 'None';
            document.getElementById('inquiryModal').style.display = 'flex';
            database.ref('messages/' + key).update({ read: true });
        }
        function closeModal() { document.getElementById('inquiryModal').style.display = 'none'; }

        function loadInquiries() {
            database.ref('messages').orderByChild('timestamp').on('value', (snapshot) => {
                const tbody = document.getElementById('inquiryTableBody');
                const unreadEl = document.getElementById('unreadCount');
                if(!tbody) return;
                tbody.innerHTML = '';
                let unreadCount = 0;
                let items = [];
                snapshot.forEach(child => {
                    const data = child.val();
                    if(!data.read) unreadCount++;
                    items.push({ key: child.key, ...data });
                });
                items.reverse().forEach(item => {
                    const row = document.createElement('tr');
                    row.className = "hover:bg-white/10 cursor-pointer transition " + (!item.read ? 'unread-row' : '');
                    const safeName = escapeHtml(item.name || 'N/A');
                    const safeCompany = escapeHtml(item.company || '-');
                    const safeEmail = escapeHtml(item.email || '');
                    const safeDate = item.date || '';
                    const safePhone = escapeHtml(item.phone || 'N/A');
                    const safeProduct = escapeHtml(item.product || 'None');
                    row.onclick = () => openInquiry(item.key, safeName, safeDate, safeCompany, safeEmail, item.details, safePhone, safeProduct);
                    row.innerHTML = `
                        <td class="p-4"><span class="${item.read ? 'text-neutral-600' : 'text-amber-400 font-bold'} text-xs">${item.read ? 'READ' : '● NEW'}</span></td>
                        <td class="p-4"><div class="text-neutral-500 text-[10px]">${safeDate}</div><div class="text-white font-bold">${safeName}</div></td>
                        <td class="p-4"><div class="text-cyan-400 font-bold">${safeCompany}</div><div class="text-amber-500 text-xs font-bold uppercase mt-1">${safeProduct}</div></td>
                        <td class="p-4"><div class="text-neutral-300 truncate max-w-xs opacity-70">${escapeHtml(item.details)}</div></td>
                        <td class="p-4 text-right space-x-2" onclick="event.stopPropagation()">
                            <button onclick="deleteInquiry('${item.key}')" class="text-red-500 hover:text-red-400 text-xs font-bold">Del</button>
                        </td>`;
                    tbody.appendChild(row);
                });
                unreadEl.innerText = unreadCount + " NEW";
            });
        }

        function deleteInquiry(key) { if(confirm("Delete?")) database.ref('messages/' + key).remove(); }

        const quill = new Quill('#editor-container', {
            theme: 'snow',
            modules: { toolbar: [[{'header': [1, 2, 3, false]}], ['bold', 'italic', 'underline'], ['image', 'link'], [{'list': 'ordered'}, {'list': 'bullet'}], ['clean']] },
            placeholder: 'Write content here...'
        });

        function updateFormText() {
            const cat = document.getElementById('postCategory').value;
            const btn = document.getElementById('submitBtn');
            const editKey = document.getElementById('editKey').value;
            if(!editKey) {
                document.getElementById('formTitle').innerHTML = `<span class="w-2 h-2 bg-cyan-500 rounded-full animate-ping"></span> POST NEW ${cat.toUpperCase()}`;
                btn.innerText = `REGISTER ${cat.toUpperCase()} (POST)`;
            }
        }

        function uploadNotice() {
            const category = document.getElementById('postCategory').value;
            const title = document.getElementById('noticeTitle').value;
            const content = quill.root.innerHTML;
            const editKey = document.getElementById('editKey').value;
            if(!title || quill.getText().trim().length === 0) return alert("Enter title and content.");
            const data = { category, title, content, date: new Date().toLocaleDateString(), timestamp: Date.now() };
            const targetPath = 'notices/' + (editKey || database.ref('notices').push().key);
            database.ref(targetPath).set(data).then(() => { alert("Saved."); resetForm(); });
        }

        function resetForm() {
            document.getElementById('editKey').value = '';
            document.getElementById('noticeTitle').value = '';
            quill.setContents([]);
            document.getElementById('noticeFormSection').classList.remove('edit-mode');
            document.getElementById('cancelBtn').classList.add('hidden');
            document.getElementById('postCategory').disabled = false;
            updateFormText();
        }

        database.ref('notices').orderByChild('timestamp').on('value', (snapshot) => {
            const tbody = document.getElementById('noticeTableBody');
            tbody.innerHTML = '';
            let items = [];
            snapshot.forEach(child => { items.push({ key: child.key, ...child.val() }); });
            items.reverse().forEach(item => {
                const isNews = item.category === 'news';
                const badgeClass = isNews ? 'bg-amber-500/20 text-amber-500 border-amber-500/50' : 'bg-cyan-500/20 text-cyan-500 border-cyan-500/50';
                const tr = document.createElement('tr');
                tr.className = "hover:bg-white/5 transition";
                tr.innerHTML = `
                    <td class="p-4"><span class="px-2 py-0.5 border text-[10px] font-bold rounded ${badgeClass}">${(item.category || 'notice').toUpperCase()}</span></td>
                    <td class="p-4 text-neutral-500 text-xs">${item.date}</td>
                    <td class="p-4 font-bold text-neutral-200">${item.title}</td>
                    <td class="p-4 text-right space-x-2">
                        <button onclick="handleEditClick('${item.key}', '${item.category || 'notice'}', \`${item.title}\`, '${encodeURIComponent(item.content)}')" class="text-cyan-400 hover:text-cyan-300 text-xs font-bold uppercase">Edit</button>
                        <button onclick="deleteNotice('${item.key}')" class="text-red-500 hover:text-red-400 text-xs font-bold uppercase">Delete</button>
                    </td>`;
                tbody.appendChild(tr);
            });
        });

        function handleEditClick(key, category, title, content) {
            document.getElementById('editKey').value = key;
            document.getElementById('postCategory').value = category;
            document.getElementById('postCategory').disabled = true;
            document.getElementById('noticeTitle').value = title;
            quill.root.innerHTML = decodeURIComponent(content);
            document.getElementById('formTitle').innerText = "EDIT " + category.toUpperCase();
            document.getElementById('submitBtn').innerText = "UPDATE " + category.toUpperCase() + " (SAVE)";
            document.getElementById('noticeFormSection').classList.add('edit-mode');
            document.getElementById('cancelBtn').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        function deleteNotice(key) { if(confirm("Delete this?")) database.ref('notices/' + key).remove(); }

        function loadAnalytics() {
            database.ref('visits').orderByChild('timestamp').on('value', (snapshot) => {
                const tableBody = document.getElementById('visitTableBody');
                if (!tableBody) return;
                tableBody.innerHTML = '';
                let rawData = [];
                if (snapshot.exists()) { snapshot.forEach(c => { const val = c.val(); if (val && val.timestamp) rawData.push(val); }); }
                rawData.sort((a, b) => b.timestamp - a.timestamp);
                const groupedData = [];
                const map = new Map();
                rawData.forEach(v => {
                    const key = `${v.ip}_${v.os}`;
                    if (!map.has(key)) {
                        const entry = { ...v, count: 1, lastAccess: v.timeStr };
                        map.set(key, entry);
                        groupedData.push(entry);
                    } else { map.get(key).count += 1; }
                });
                document.getElementById('totalCount').innerText = rawData.length;
                document.getElementById('uniqueCount').innerText = new Set(rawData.map(v => v.ip)).size;
                groupedData.forEach(v => {
                    const row = document.createElement('tr');
                    row.className = "hover:bg-white/5 transition border-b border-white/5";
                    row.innerHTML = `
                        <td class="p-5 text-center"><div class="flex flex-col items-center"><span class="bg-cyan-500 text-black px-2 py-0.5 rounded text-[10px] font-black mb-1">${v.count}</span><span class="text-[9px] text-neutral-500 uppercase tracking-tighter">Hits</span></div></td>
                        <td class="p-5"><div class="text-neutral-400 text-xs font-mono">${v.lastAccess || '-'}</div><div class="text-cyan-500 text-sm font-black">${v.ip || '0.0.0.0'}</div></td>
                        <td class="p-5"><div class="text-white font-bold">${v.country || 'Unknown'}</div><div class="text-neutral-500 text-xxs">${v.city || ''}</div></td>
                        <td class="p-5 text-center"><div class="flex flex-col gap-1 items-center"><span class="px-2 py-1 rounded text-xxs bg-neutral-800 text-neutral-300 w-24 truncate">${v.os || 'OS'}</span><span class="px-2 py-1 rounded text-xxs bg-cyan-900/20 text-cyan-500 w-24 truncate">${v.browser || v.device || 'Device'}</span></div></td>
                        <td class="p-5"><div class="font-bold text-cyan-400 text-xs">${v.page || '/'}</div><div class="text-neutral-600 text-[10px] truncate max-w-[150px]">${v.referrer ? 'via ' + new URL(v.referrer).hostname : 'Direct'}</div></td>`;
                    tableBody.appendChild(row);
                });
            });
        }

// 초기 로드 시 현재 비밀번호 불러오기 (window.onload 안에 배치)
window.onload = () => { 
    loadHeader();
    loadInquiries(); 
    loadAnalytics(); 
    updateFormText(); 

    // Firebase에서 현재 저장된 비밀번호 가져와서 입력창에 표시
    database.ref('adminConfig/password').once('value', (snapshot) => {
        if (snapshot.exists()) {
            const currentPw = snapshot.val();
            const inputField = document.getElementById('adminNewPassword');
            if(inputField) inputField.value = currentPw;
        }
    });
};

    </script>
</body>
</html>