<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TDLiD Admin - Security & Audit Logs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { background-color: #020617; color: #e5e7eb; font-family: 'Pretendard', sans-serif; }
        .tab-item { transition: all 0.3s ease; position: relative; }
        .tab-item.active { color: #22d3ee; }
        .tab-item.active::after {
            content: ''; position: absolute; bottom: -25px; left: 0; width: 100%; height: 2px;
            background: #22d3ee; box-shadow: 0 0 10px #22d3ee;
        }
        .log-container::-webkit-scrollbar { width: 4px; }
        .log-container::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
    </style>
</head>
<body class="p-8">
    <div class="max-w-6xl mx-auto">
        <header class="mb-12 border-b border-cyan-900/50 pb-6 flex flex-col md:flex-row md:items-end justify-between gap-6">
            <div>
                <h1 class="text-4xl font-bold text-cyan-400 tracking-tighter italic">ADMIN SYSTEM</h1>
                <p class="text-neutral-500 text-sm mt-1 uppercase tracking-widest">TDL Energy Indonesia Management</p>
            </div>

            <nav class="flex gap-8 text-sm font-bold uppercase tracking-wider text-neutral-500">
                <a href="admin.html" class="tab-item hover:text-white transition">Dashboard</a>
                <a href="visitor.html" class="tab-item hover:text-white transition">Visitor</a>
                <a href="inquiry.html" class="tab-item hover:text-white transition">Inquiry</a>
                <a href="post.html" class="tab-item hover:text-white transition">Posts</a>
                <a href="security.html" class="tab-item active hover:text-white transition">Security</a>
            </nav>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12">
            <div class="lg:col-span-1 flex flex-col items-center">
                <div class="w-full bg-neutral-900/50 p-8 rounded-3xl border border-red-900/30 shadow-2xl">
                    <div class="text-red-500 text-4xl mb-4">üõ°Ô∏è</div>
                    <h2 class="text-2xl font-bold text-white mb-2">Password</h2>
                    <p class="text-neutral-500 text-xs mb-8 uppercase tracking-tight">Access Key Management</p>

                    <div class="space-y-4 text-left">
                        <div>
                            <label class="text-[10px] font-bold text-neutral-500 uppercase tracking-widest ml-1">Current / New Admin Password</label>
                            <input type="text" id="adminNewPassword" class="w-full bg-black border border-neutral-800 p-4 rounded-xl mt-2 outline-none focus:border-red-500 transition font-mono text-red-400" placeholder="Loading...">
                        </div>
                        <button onclick="updatePw()" class="w-full py-4 bg-red-600/10 hover:bg-red-600 border border-red-600/50 text-red-500 hover:text-white font-black rounded-xl transition uppercase tracking-widest text-xs">
                            Confirm Change
                        </button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2 space-y-8">
                <div class="bg-neutral-900/30 border border-white/5 rounded-3xl p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-cyan-400 uppercase tracking-widest text-sm italic">Audit & Login Logs</h3>
                        <span class="text-[10px] text-neutral-500 uppercase font-mono tracking-tighter">Auto-Session: 30m Active</span>
                    </div>
                    
                    <div class="log-container overflow-y-auto max-h-[400px] pr-2">
                        <table class="w-full text-left">
                            <thead class="text-[10px] text-neutral-600 uppercase border-b border-white/5">
                                <tr>
                                    <th class="pb-3 pl-2">Event</th>
                                    <th class="pb-3">Details / IP</th>
                                    <th class="pb-3 text-right pr-2">Time</th>
                                </tr>
                            </thead>
                            <tbody id="auditLogList" class="text-xs">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-center">
            <button onclick="location.href='admin.html'" class="text-xs text-neutral-600 hover:text-neutral-400 transition">Return to Dashboard</button>
            <div class="mt-4">
                <a href="../index.html" class="text-neutral-600 hover:text-cyan-400 text-xs transition">‚Üê Exit to Public Website</a>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDwF8_Q9S1-naaAgyfMWhFYJ2u_be3wsBs",
            authDomain: "tdlid-107669.firebaseapp.com",
            databaseURL: "https://tdlid-107669-default-rtdb.firebaseio.com",
            projectId: "tdlid-107669",
            storageBucket: "tdlid-107669.firebasestorage.app",
            messagingSenderId: "604782345004",
            appId: "1:604782345004:web:029aeaa81f4d11c2254a89"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // --- Î≥¥Ïïà Í∏∞Îä• 1: ÏÑ∏ÏÖò ÎßåÎ£å Î°úÏßÅ (30Î∂Ñ Î¨¥ÌôúÎèô Ïãú Î°úÍ∑∏ÏïÑÏõÉ) ---
        const SESSION_TIMEOUT = 30 * 60 * 1000; // 30Î∂Ñ
        let lastActivity = Date.now();

        function checkSession() {
            if (Date.now() - lastActivity > SESSION_TIMEOUT) {
                alert("Session expired due to inactivity. Please log in again.");
                sessionStorage.removeItem('isAdminAuthenticated');
                window.location.href = "../index.html";
            }
        }

        window.onload = () => {

            loadCurrentPw();
            loadAuditLogs();
            recordAdminAction("ACCESS", "Security Management Page Viewed");
        };

        document.onmousemove = () => lastActivity = Date.now();
        document.onkeypress = () => lastActivity = Date.now();
        setInterval(checkSession, 10000); // 10Ï¥àÎßàÎã§ ÏÑ∏ÏÖò Ï≤¥ÌÅ¨

        // --- Î≥¥Ïïà Í∏∞Îä• 2: Î°úÍ∑∏ Í∏∞Î°ù Ìï®Ïàò ---
        async function recordAdminAction(type, detail) {
            try {
                let ip = "0.0.0.0";
                try {
                    const res = await fetch('https://api.ipify.org?format=json');
                    const data = await res.json();
                    ip = data.ip;
                } catch(e) {}

                await database.ref('adminLogs').push({
                    type: type, // PASSWORD_CHANGE, ACCESS, DELETE_POST Îì±
                    detail: detail,
                    ip: ip,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    timeStr: new Date().toLocaleString()
                });
            } catch (err) { console.error("Log Error:", err); }
        }

        // --- Í∏∞Ï°¥ Í∏∞Îä• Í∞ïÌôî: Ìå®Ïä§ÏõåÎìú Î≥ÄÍ≤Ω Î∞è Î°úÍ∑∏ Ïó∞Îèô ---
        async function loadCurrentPw() {
            const pwInput = document.getElementById('adminNewPassword');
            try {
                const snapshot = await database.ref('adminConfig/password').once('value');
                if (snapshot.exists()) pwInput.value = snapshot.val();
                else pwInput.placeholder = "No password set";
            } catch (error) { pwInput.placeholder = "Error loading"; }
        }

        async function updatePw() {
            const newPw = document.getElementById('adminNewPassword').value;
            if(!newPw) return alert("Please enter a new password.");
            
            if(confirm("Change admin access password? This action will be logged.")) {
                try {
                    await database.ref('adminConfig/password').set(newPw);
                    await recordAdminAction("PASSWORD_CHANGE", "Administrator Password Updated");
                    alert("Security password updated successfully.");
                } catch (error) { alert("Update failed: " + error.message); }
            }
        }

        // --- Î≥¥Ïïà Í∏∞Îä• 3: Î°úÍ∑∏ Î¶¨Ïä§Ìä∏ ÌëúÏãú ---
        function loadAuditLogs() {
            const logTbody = document.getElementById('auditLogList');
            database.ref('adminLogs').limitToLast(50).on('value', (snapshot) => {
                logTbody.innerHTML = '';
                const logs = [];
                snapshot.forEach(child => { logs.push(child.val()); });
                logs.reverse().forEach(log => {
                    const typeColor = log.type === 'PASSWORD_CHANGE' ? 'text-red-500' : 'text-cyan-500';
                    const row = `
                        <tr class="border-b border-white/5 hover:bg-white/[0.02] transition">
                            <td class="py-4 pl-2 font-black ${typeColor}">${log.type}</td>
                            <td class="py-4 text-neutral-400">
                                <div>${log.detail}</div>
                                <div class="text-[9px] font-mono text-neutral-600 mt-1">${log.ip}</div>
                            </td>
                            <td class="py-4 text-right text-neutral-500 font-mono text-[10px] pr-2">${log.timeStr}</td>
                        </tr>
                    `;
                    logTbody.innerHTML += row;
                });
            });
        }
    </script>
</body>
</html>