<style>
    #musicToggleBtn { 
        position: fixed; bottom: 25px; right: 25px; z-index: 10005; 
        width: 44px; height: 44px; background: rgba(23, 23, 23, 0.8); 
        border: 1px solid rgba(34, 211, 238, 0.4); border-radius: 50%; 
        display: flex; align-items: center; justify-content: center; 
        cursor: pointer; color: #22d3ee; backdrop-filter: blur(4px); 
        transition: all 0.3s; 
    }
    #musicToggleBtn:hover { transform: scale(1.1); border-color: #22d3ee; }
</style>

<audio id="bgm" src="mp3/tdlid.mp3" loop muted preload="auto"></audio>

<button id="musicToggleBtn" title="Play/Pause Music">
    <span id="musicIconUI">ğŸ”‡</span>
</button>

<script>
    (function() {
        const bgm = document.getElementById('bgm');
        const musicBtn = document.getElementById('musicToggleBtn');
        const musicIcon = document.getElementById('musicIconUI');

        // 1. ì´ˆê¸° ìƒíƒœ ì„¤ì • í•¨ìˆ˜
        const initBGM = () => {
            const savedTime = sessionStorage.getItem('bgmTime');
            const isMuted = sessionStorage.getItem('bgmMuted');

            // ì €ì¥ëœ ì¬ìƒ ìœ„ì¹˜ ë³µì›
            if (savedTime) {
                bgm.currentTime = parseFloat(savedTime);
            }

            // ìŒì†Œê±° ìƒíƒœ ë³µì› (ê¸°ë³¸ê°’ì€ muted=true)
            if (isMuted === 'false') {
                bgm.muted = false;
                musicIcon.innerText = "ğŸµ";
                // ë¸Œë¼ìš°ì € ì •ì±…ìƒ ì²« ë¡œë“œ ì‹œ ìë™ì¬ìƒì´ ë§‰í ìˆ˜ ìˆìœ¼ë¯€ë¡œ play() ì‹œë„
                bgm.play().catch(() => {
                    // ìë™ì¬ìƒ ì°¨ë‹¨ ì‹œ ë‹¤ì‹œ ìŒì†Œê±° ìƒíƒœë¡œ UI ì„¸íŒ…
                    bgm.muted = true;
                    musicIcon.innerText = "ğŸ”‡";
                });
            } else {
                bgm.muted = true;
                musicIcon.innerText = "ğŸ”‡";
            }
        };

        // 2. ìƒíƒœ ì €ì¥ í•¨ìˆ˜ (ì¬ìƒ ì‹œê°„ ì‹¤ì‹œê°„ ê¸°ë¡)
        const saveStatus = () => {
            sessionStorage.setItem('bgmTime', bgm.currentTime);
            sessionStorage.setItem('bgmMuted', bgm.muted);
        };

        if (musicBtn && bgm) {
            // ì´ˆê¸°í™” ì‹¤í–‰
            initBGM();

            // í´ë¦­ ì´ë²¤íŠ¸
            musicBtn.onclick = () => {
                if (bgm.muted) {
                    bgm.muted = false;
                    bgm.play().catch(e => console.log("User interaction required"));
                    musicIcon.innerText = "ğŸµ";
                } else {
                    bgm.muted = true;
                    musicIcon.innerText = "ğŸ”‡";
                }
                saveStatus();
            };

            // ì¬ìƒ ì¤‘ ì£¼ê¸°ì ìœ¼ë¡œ ì‹œê°„ ì €ì¥ (1ì´ˆ ê°„ê²©)
            setInterval(saveStatus, 1000);

            // í˜ì´ì§€ë¥¼ ë– ë‚˜ê¸° ì§ì „ì— ìµœì¢… ì‹œê°„ ì €ì¥
            window.addEventListener('beforeunload', saveStatus);
        }
    })();
</script>
