<style>
    #musicToggleBtn { 
        position: fixed; bottom: 25px; right: 25px; z-index: 10005; 
        width: 44px; height: 44px; background: rgba(23, 23, 23, 0.8); 
        border: 1px solid rgba(34, 211, 238, 0.4); border-radius: 50%; 
        display: flex; align-items: center; justify-content: center; 
        cursor: pointer; color: #22d3ee; backdrop-filter: blur(4px); 
        transition: all 0.3s; 
    }
    #musicToggleBtn:active { transform: scale(0.9); } /* ëª¨ë°”ì¼ í„°ì¹˜ í”¼ë“œë°± */
</style>

<audio id="bgm" src="mp3/tdlid.mp3" loop preload="auto" playsinline></audio>

<button id="musicToggleBtn" title="Play/Pause Music">
    <span id="musicIconUI">ğŸ”‡</span>
</button>

<script>

  (function() {
    const bgm = document.getElementById('bgm');
    const musicBtn = document.getElementById('musicToggleBtn');
    const musicIcon = document.getElementById('musicIconUI');

 const initBGM = () => {
    const savedTime = sessionStorage.getItem('bgmTime');
    const isMuted = sessionStorage.getItem('bgmMuted') === 'true';

    if (savedTime) bgm.currentTime = parseFloat(savedTime);
    
    // í•µì‹¬: ì¼ë‹¨ ìŒì†Œê±° ìƒíƒœë¥¼ ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì— ë”°ë¼ ëª…ì‹œì ìœ¼ë¡œ ì„¤ì •
    bgm.muted = isMuted;

    if (!isMuted) {
      // ì¬ìƒ ì‹œë„
      const playPromise = bgm.play();

      if (playPromise !== undefined) {
        playPromise.then(() => {
          musicIcon.innerText = "ğŸµ";
        }).catch(err => {
          // ìë™ ì¬ìƒ ì°¨ë‹¨ ì‹œ: ë²„íŠ¼ì€ ì¬ìƒ ì¤‘ìœ¼ë¡œ ë³´ì—¬ì£¼ê³  í„°ì¹˜ ëŒ€ê¸°
          console.log("Autoplay blocked. Waiting for interaction...");
          musicIcon.innerText = "ğŸµ";

          const forcePlay = () => {
            bgm.play().then(() => {
              // ì„±ê³µ ì‹œ ì´ë²¤íŠ¸ ì œê±°
              document.removeEventListener('touchstart', forcePlay);
              document.removeEventListener('click', forcePlay);
            });
          };
          // ì‚¬ìš©ìê°€ í˜ì´ì§€ ì–´ë””ë“  í„°ì¹˜í•˜ëŠ” ìˆœê°„ ë°”ë¡œ ì¬ìƒë˜ë„ë¡ í•¨
          document.addEventListener('touchstart', forcePlay, { once: true });
          document.addEventListener('click', forcePlay, { once: true });
        });
      }
    } else {
      musicIcon.innerText = "ğŸ”‡";
    }
  };


        if (musicBtn && bgm) {
            initBGM();

            // 2. ë²„íŠ¼ í´ë¦­ ìˆ˜ë™ ì œì–´
            musicBtn.onclick = (e) => {
                e.stopPropagation();
                if (bgm.muted || bgm.paused) {
                    bgm.muted = false;
                    bgm.play();
                    musicIcon.innerText = "ğŸµ";
                    sessionStorage.setItem('bgmMuted', 'false');
                } else {
                    bgm.muted = true;
                    musicIcon.innerText = "ğŸ”‡";
                    sessionStorage.setItem('bgmMuted', 'true');
                }
            };

            // 3. ìƒíƒœ ì €ì¥ (ëª¨ë°”ì¼ í™˜ê²½ì— ë§ì¶° 1.5ì´ˆ ê°„ê²© ì¡°ì •)
            setInterval(() => {
                if (!bgm.paused && bgm.currentTime > 0) {
                    sessionStorage.setItem('bgmTime', bgm.currentTime);
                }
            }, 1500);

            // í˜ì´ì§€ ì´íƒˆ ì‹œ ì €ì¥ (ëª¨ë°”ì¼ì€ pagehideê°€ ë” ì‹ ë¢°ë„ ë†’ìŒ)
            window.addEventListener('pagehide', () => {
                sessionStorage.setItem('bgmTime', bgm.currentTime);
                sessionStorage.setItem('bgmMuted', bgm.muted);
            });
        }
    })();
</script>